# Software Design course 2022

Команда: Субботина Олеся, Анисимова Карина, Багрянова Катя

____

## Описание архитектуры

### MyShell

Основной класс, запуск происходит из него

* Стандартные потоки ввода и вывода
* Чтение запроса
* Запуск Preprocessing и Execution
* Получение результата Execution и вывод его в поток вывода


### Preprocessing

Класс для предобработки запроса

Предобработка: делаем подстановку переменных, обрабатываем кавычки. (Обновление текущих переменных окружения на ходу не поддерживается)

Обработка: один проход по строке.

Чтобы корректно обрабатывать кавычки храним самую левую незакрытую:
* Если кавычки еще не встречены -  просто делаем подстановки, пока не встретим первую кавычку.
* Если двойная - делаем все подстановки и считаем одинарные кавычки просто символами, пока не встретим закрывающую двойную.
* Если одинарная - считаем ее содержимое строкой, подстановки не делаем, пока не встретим ее закрывающую.

Поддерживаемые виды переменных:
* Одна цифра
* Набор букв и цифр, начинающийся с буквы

Символы кроме букв и цифр не поддерживаются. Переменные, начинающиеся с цифры, длины > 1 не поддерживаются.

Процесс подстановки:
* Набор переменной:
  * Если встретили цифру после знака $, то добавляем после нее пробел, чтобы разбить аргументы вида `$1x` на `$1 x`, считаем, что нашли переменную `$1`
  * Иначе после знака $ набираем переменную, пока не встретим символ, отличный от буквы или цифры
* Подстановка:
  * Если такая переменная была ранее запомнена в environment, то делаем подстановку
  * Иначе оставляем как есть (т.е. вида `${переменная}`). Такие случаи обрабатываются внутри каждой команды отдельно.

### Execution

Класс для выполнения запроса

Компоненты:
* Метод executeAll: 
  * Инициализирует парсер
  * В цикле обращается к методу getNext парсера
  * Проверяем, что существует класс, соответствующий этой команде. 
  Если команда поддерживаемая — отдаем ее статические и динамические аргументы 
  (см. в описании класса команды) конкретному классу для этой команды. Иначе отдаем в класс OuterCommand 
  * Запускаем у команды метод execute.
  Получаем результат исполнения команды (сохраняем его в переменную) и передаем его как динамический аргумент следующей команде. 
  * Возвращаем итоговый результат (результат последней команды).
* Класс Parser: парсит строку на команду и аргументы
  * Инициализируем целой строкой, полученной после предобработки
  * Метод getNext - отрезает очередную слева часть запроса по пайпу, если это еще возможно. 
  Затем по пробелам разбивает ее на команду и аргументы. 
  Возвращает массив строк, в котором первый элемент - сама команда, остальные - ее аргументы.


### Abstract Command

Абстрактный класс, описывающий функциональность команды

Команда поддерживает два вида аргументов:
* Статические: аргументы, переданы команде напрямую
* Динамические: аргументы, которые получены как результат выполнения предыдущей команды
* Обрабатываются одинаково, сначала динамические, потом статические


Коды возврата:
* Код, соответствующий ошибке некорректности аргумента
* Код, соответствующий успешному выполнению команды
* Код, соответствующий ошибке при выполнении команды
* Код, соответствующий завершению работы

Компоненты:
* Поля: статические и динамические аргументы (массивы строк, в каждой конкретной команде будем кастовать к нужным типам),
logger, exit code
* Методы: 
  * execute — выполняет команду и возвращает результат и exit code, соответствующий успешному выполнению команды либо ошибке при выполнении команды
  * валидация аргументов — проверяет корректность аргументов
* От него наследуются классы конкретных команд, класс внешних команд, класс для обработки присваивания

Команды: 
* Класс CommandCat
  * Валидация аргументов: если первый символ аргумента - $, такого файла не существует или аргументов нет, то возвращаем код возврата, соответствующий ошибке некорректности аргумента
  * execute: читаем содержимое файлов, конкатенируем через '\n' и возвращаем
* Класс CommandEcho 
  * Валидация аргументов: если первый символ аргумента - $, то игнорируем его
  * execute: возвращаем строку, полученную конкатенацией переданных аргументов через пробел
* Класс CommandWc
  * Валидация аргументов: если первый символ аргумента - $, такого файла не существует или аргументов нет, то возвращаем код возврата, соответствующий ошибке некорректности аргумента
  * execute: считаем количество строк, слов и байт в файле, конкатенируем по файлам через '\n', возвращаем
* Класс CommandPwd
  * Валидация аргументов: игнорируем аргументы
  * execute: возвращаем текущую директорию
* Класс CommandExit
  * Валидация аргументов: игнорируем аргументы
  * execute: возвращает exit code, соответствующий завершению работы
* Класс CommandOuter
  * Валидация аргументов: если первый символ аргумента - $, то возвращаем ошибку некорректности аргумента
  * execute: реализован с использованием Java.Process
* Класс CommandAssignment
  * Валидация аргументов: если первый символ аргумента - $, количество аргументов != 1, то возвращаем код возврата, соответствующий ошибке некорректности аргумента
  * execute: обновляем или создаем переменную окружения в environment

### Environment

Класс, в котором хранятся переменные окружения — словарь

____

## Схема архитектуры

<br></br>
![architecture](assets/architecture.png)
<br></br>
